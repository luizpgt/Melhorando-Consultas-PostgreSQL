# 3ª consulta mais custosa (tempo): Questão 7

### Query Inicial:

``` sql
    SELECT distinct 
        sum(e.salario) over(partition by d.dep_id), d.nome 
    FROM empregados e 
    JOIN departamentos d 
    ON e.dep_id = d.dep_id 
    ORDER BY sum;
 ```

mais promissora :

with s as (select e.dep_id, sum(e.salario) from empregados e group by e.dep_id) select s.sum, d.nome from departamentos d join s on d.dep_id = s.dep_id where d.dep_id = s.dep_id order by sum;
### Tempo gasto na Consulta 

    Execution Time: 7564.615 ms
    Execution Time: 7284.495 ms
    Execution Time: 7455.624 ms
    Execution Time: 7537.207 ms
    Execution Time: 7607.683 ms

### Query Plan capturado com cache vazio

``` sql
                                                                          QUERY PLAN                                                                           
---------------------------------------------------------------------------------------------------------------------------------------------------------------
 Sort  (cost=1975815.06..1975819.51 rows=1780 width=25) (actual time=7326.466..7326.469 rows=32 loops=1)
   Sort Key: (sum(e.salario) OVER (?))
   Sort Method: quicksort  Memory: 27kB
   Buffers: shared hit=3 read=66944, temp read=111693 written=102850
   ->  HashAggregate  (cost=1975701.16..1975718.96 rows=1780 width=25) (actual time=7326.395..7326.404 rows=32 loops=1)
         Group Key: sum(e.salario) OVER (?), d.nome
         Batches: 1  Memory Usage: 73kB
         Buffers: shared read=66944, temp read=111693 written=102850
         ->  WindowAgg  (cost=1603061.00..1925701.16 rows=10000000 width=25) (actual time=2635.109..6492.977 rows=9696700 loops=1)
               Buffers: shared read=66944, temp read=111693 written=102850
               ->  Merge Join  (cost=1603061.00..1775701.16 rows=10000000 width=21) (actual time=2529.297..4417.148 rows=9696700 loops=1)
                     Merge Cond: (d.dep_id = e.dep_id)
                     Buffers: shared read=66944, temp read=43418 written=65534
                     ->  Sort  (cost=2.16..2.24 rows=33 width=17) (actual time=386.517..386.528 rows=33 loops=1)
                           Sort Key: d.dep_id
                           Sort Method: quicksort  Memory: 26kB
                           Buffers: shared read=1
                           ->  Seq Scan on departamentos d  (cost=0.00..1.33 rows=33 width=17) (actual time=386.477..386.482 rows=33 loops=1)
                                 Buffers: shared read=1
                     ->  Materialize  (cost=1603058.83..1653058.83 rows=10000000 width=8) (actual time=2142.751..3402.170 rows=9696701 loops=1)
                           Buffers: shared read=66943, temp read=43418 written=65534
                           ->  Sort  (cost=1603058.83..1628058.83 rows=10000000 width=8) (actual time=2142.747..2658.243 rows=9696701 loops=1)
                                 Sort Key: e.dep_id
                                 Sort Method: external merge  Disk: 176200kB
                                 Buffers: shared read=66943, temp read=43418 written=44228
                                 ->  Seq Scan on empregados e  (cost=0.00..166943.00 rows=10000000 width=8) (actual time=0.954..959.785 rows=10000000 loops=1)
                                       Buffers: shared read=66943
 Planning:
   Buffers: shared hit=72 read=19
 Planning Time: 7.519 ms
 JIT:
   Functions: 21
   Options: Inlining true, Optimization true, Expressions true, Deforming true
   Timing: Generation 4.279 ms, Inlining 84.503 ms, Optimization 147.880 ms, Emission 153.672 ms, Total 390.335 ms
 Execution Time: 7607.683 ms
(35 rows)
```

### Média e Desvio padrão de 5 execuções com os buffers limpos:

| Média Aritmética | Desvio Padrão | Unidade Medida |
|:--------:|:-------------:|:------|
| 7489.92480 |  127.53349 | ms |

### Explicando Plano de Consulta:

```
->  Seq Scan on departamentos d
->  Sort
        Sort Key: d.dep_id
        Sort Method: quicksort  Memory: 26kB
->  Seq Scan on empregados e 
->  Sort 
        Sort Key: e.dep_id
        Sort Method: external merge  Disk: 176200kB
->  Materialize
->  Merge Join
        Merge Cond: (d.dep_id = e.dep_id)
->  WindowAgg
->  HashAggregate
        Group Key: sum(e.salario) OVER (?), d.nome
->  Sort
        Sort Key: (sum(e.salario) OVER (?))
        Sort Method: quicksort  Memory: 27kB
```

#### Descrições:

1. Seq Scan na tabela `departamentos` retorna todos os departamentos cadastrados para o apelido `d`;
2. Os registros são então ordenados pela coluna `dep_id`, que é chave primária de `departamentos`;
3. Seq Scan na tabela `empregados` retorna todos os empregados cadastrados para o apelido `e`;
4. Registros são então ordenados pela coluna `dep_id`;
5. É materializada o resultado da leitura de `e` ordenado por `dep_id`;
6. Acontece um `JOIN`, entre os registros ordenados de `d` e a tabela materializada de `e`;
7. A Window Function é então aplicada. Essa função é causada pelo statement `OVER` na Query;
8. As tuplas sofrem uma operação de `GROUP BY` por todas as colunas usando uma `hash table` -> distinct;
9. Os dados resultantes são ordenados pela `sum` dos salários de cada departamento;

#### Observações:

- É possível notar em (1 ^ 3) Seq Scans sobre tabelas diferentes. Apesar disso, os tempos de início das operações se sobrepõem - elas parecem acontecer simultaneamente.
- A ordenação em (4) é feita usando `external merge Disk` que é indício de pouca memória disponível para a operação.
- Em várias operações os dados são manipulados no disco.
- Em (6) o agoritmo usado para fazer o `JOIN` é o `Merge Join`

### Tentativas de melhoria

Resumo: 
- Criação de `índices`;
- Alteração em `parâmetros` do SGBD;

Novos índices criado para a Tabela `empregados` e `departamentos`:

```sql 
CREATE INDEX dep_id_empregados ON empregados (dep_id);
CREATE INDEX dep_id_departamentos ON departamentos (dep_id);
```

```sql 
CLUSTER empregados USING dep_id_empregados ;
CLUSTER departamentos USING dep_id_departamentos;
```

Alterando PostgreSQL configuration file:

```bash
sudo vim /var/lib/postgres/data/postgresql.conf
```

| Parameter | Old/Default value | New Value |
|:--------:|:-------------:|:------|
| work_mem | 4MB | 500MB |
| random_page_cost | 4.0 | 1.0 |

* Tentativas de modificação na `query` apresentaram `mudanças significativas` de performance.

### Resultados encontrados

#### Com antiga query, indexes clusterizados e as alterações no SGBD:

```sql
                                                                                 QUERY PLAN                                                                                  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Sort  (cost=542644.60..542649.05 rows=1780 width=25) (actual time=4745.520..4745.522 rows=32 loops=1)
   Sort Key: (sum(e.salario) OVER (?))
   Sort Method: quicksort  Memory: 27kB
   Buffers: shared hit=5 read=73079
   ->  HashAggregate  (cost=542530.70..542548.50 rows=1780 width=25) (actual time=4745.421..4745.430 rows=32 loops=1)
         Group Key: sum(e.salario) OVER (?), d.nome
         Batches: 1  Memory Usage: 73kB
         Buffers: shared hit=2 read=73079
         ->  WindowAgg  (cost=0.57..492530.70 rows=10000000 width=25) (actual time=459.028..3927.790 rows=9696700 loops=1)
               Buffers: shared hit=2 read=73079
               ->  Merge Join  (cost=0.57..342530.70 rows=10000000 width=21) (actual time=359.810..2069.666 rows=9696700 loops=1)
                     Merge Cond: (d.dep_id = e.dep_id)
                     Buffers: shared hit=2 read=73079
                     ->  Index Scan using dep_id_departamentos on departamentos d  (cost=0.14..3.64 rows=33 width=17) (actual time=0.029..0.047 rows=33 loops=1)
                           Buffers: shared hit=2
                     ->  Index Scan using dep_id_empregados on empregados e  (cost=0.43..225406.43 rows=10000000 width=8) (actual time=1.427..1009.488 rows=9696701 loops=1)
                           Buffers: shared read=73079
 Planning:
   Buffers: shared hit=96 read=25
 Planning Time: 7.624 ms
 JIT:
   Functions: 17
   Options: Inlining true, Optimization true, Expressions true, Deforming true
   Timing: Generation 3.839 ms, Inlining 81.954 ms, Optimization 142.846 ms, Emission 133.573 ms, Total 362.211 ms
 Execution Time: 4997.779 ms
(25 rows)
```

Resumo Descrição/Observações:

```
->  Index Scan using dep_id_departamentos on departamentos d
->  Index Scan using dep_id_empregados on empregados e 
->  Merge Join
        Merge Cond: (d.dep_id = e.dep_id)
->  HashAggregate
        Group Key: sum(e.salario) OVER (?), d.nome
        Batches: 1  Memory Usage: 73kB
->  Sort
        Sort Key: (sum(e.salario) OVER (?))
        Sort Method: quicksort  Memory: 27kB
```

1. Pode-se notar uma clara diminuição na quantidade de operações para obter o resultado final.
2. A quantia de acessos ao disco diminuiu, visto o diminuição no número de `temp read` e `temp written`.
3. Evita Sequencial Scans e suas operações de ordenação, evita materializar uma tabela desnecessária.

#### Com nova query, indexes clusterizados e alterações no SGBD:

Nova query: 
```sql 
WITH s AS (
    SELECT
        e.dep_id, 
        SUM(e.salario)
    FROM empregados e 
    GROUP BY e.dep_id )

    SELECT 
        s.sum, d.nome 
    FROM departamentos d
    JOIN s ON d.dep_id = s.dep_id 
    WHERE d.dep_id = s.dep_id 
    ORDER BY sum;
```

### Tempo gasto na nova Consulta 

    Execution Time: 11665.226 ms
    Execution Time: 11566.505 ms
    Execution Time: 11721.102 ms
    Execution Time: 11621.350 ms
    Execution Time: 11713.056 ms

### Média e Desvio padrão de 5 execuções com os buffers limpos:

| Média Aritmética | Desvio Padrão | Unidade Medida |
|:--------:|:-------------:|:------|
| 11657.4478 |  64.76548 | ms |
